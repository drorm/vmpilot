Step 1: Running coverage analysis
Running Coverage Analysis...
----------------------------------------
Starting code coverage analysis for VMPilot...
Project root: /home/dror/vmpilot
Erasing existing coverage data...
Running unit tests with coverage...
============================= test session starts ==============================
platform linux -- Python 3.11.0rc1, pytest-8.3.3, pluggy-1.5.0
rootdir: /home/dror/vmpilot
configfile: pytest.ini
plugins: cov-6.0.0, anyio-4.8.0, asyncio-0.25.3, ddtrace-2.16.3, docker-3.1.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function
collected 286 items

tests/unit/test_agent_memory.py ........                                 [  2%]
tests/unit/test_chat_id.py ..........                                    [  6%]
tests/unit/test_config.py .....                                          [  8%]
tests/unit/test_config_values.py ....................................    [ 20%]
tests/unit/test_db.py .....                                              [ 22%]
tests/unit/test_db_config.py ...                                         [ 23%]
tests/unit/test_db_config_simple.py ...                                  [ 24%]
tests/unit/test_db_connection.py ........                                [ 27%]
tests/unit/test_db_crud.py .........                                     [ 30%]
tests/unit/test_db_shutdown.py ..                                        [ 31%]
tests/unit/test_db_simple.py .                                           [ 31%]
tests/unit/test_exchange.py ................                             [ 37%]
tests/unit/test_git_config.py ......                                     [ 39%]
tests/unit/test_git_track.py .......................................     [ 52%]
tests/unit/test_git_track2.py ..............                             [ 57%]
tests/unit/test_persistent_memory.py .....                               [ 59%]
tests/unit/test_pipe_chat_id_integration.py ....                         [ 60%]
tests/unit/test_project.py ...                                           [ 61%]
tests/unit/test_project_cli.py ....                                      [ 63%]
tests/unit/test_shell_edge_cases.py ..................                   [ 69%]
tests/unit/test_shell_extended.py ........                               [ 72%]
tests/unit/test_unified_memory.py ..                                     [ 73%]
tests/unit/test_usage_core.py ............                               [ 77%]
tests/unit/test_usage_gemini.py ..                                       [ 77%]
tests/unit/test_usage_openai.py .                                        [ 78%]
tests/unit/test_utils.py ..............                                  [ 83%]
tests/unit/test_worker_llm_unit.py .........                             [ 86%]
tests/unit/tools/test_create_file.py .....                               [ 88%]
tests/unit/tools/test_edit_file.py .......                               [ 90%]
tests/unit/tools/test_edit_file_extended.py ........                     [ 93%]
tests/unit/tools/test_google_search.py ........                          [ 96%]
tests/unit/tools/test_setup_tools.py .......                             [ 98%]
tests/unit/tools/test_shell.py ..../home/dror/.local/lib/python3.11/site-packages/pytest_cov/plugin.py:355: CovFailUnderWarning: Coverage failure: total of 61 is less than fail-under=70
  warnings.warn(CovFailUnderWarning(message), stacklevel=1)

ERROR: Coverage failure: total of 61 is less than fail-under=70
                                                                         [100%]
FAIL Required test coverage of 70.0% not reached. Total coverage: 61.41%

============================= slowest 10 durations =============================
0.20s call     tests/unit/test_shell_edge_cases.py::TestShellToolEdgeCases::test_command_with_background_process
0.04s call     tests/unit/test_pipe_chat_id_integration.py::TestPipeChatIDIntegration::test_message_truncation_with_chat_id
0.02s call     tests/unit/test_unified_memory.py::TestUnifiedMemory::test_uses_agent_memory_when_db_disabled
0.02s call     tests/unit/test_pipe_chat_id_integration.py::TestPipeChatIDIntegration::test_message_retention_without_chat_id
0.02s call     tests/unit/test_db.py::TestDatabaseConnection::test_initialize_db
0.02s call     tests/unit/test_unified_memory.py::TestUnifiedMemory::test_uses_persistent_memory_when_db_enabled
0.02s call     tests/unit/test_chat_id.py::TestChatID::test_generate_new_chat_id
0.02s call     tests/unit/test_shell_edge_cases.py::TestShellToolEdgeCases::test_command_with_pipe_to_multiple_commands
0.02s call     tests/unit/test_git_track2.py::TestGitTrackerLLMIntegration::test_generate_commit_message
0.01s call     tests/unit/test_chat_id.py::TestChatID::test_no_chat_id_in_messages
============================= 286 passed in 9.86s ==============================
Running end-to-end tests with coverage...
Creating test environment in /tmp/tmp.hTmrtsTmnx
Current working directory: /home/dror/vmpilot/tests
total 12
-rw------- 1 dror dror  60 May 24 17:12 test1.txt
-rw------- 1 dror dror  81 May 24 17:12 test2.py
-rw------- 1 dror dror 126 May 24 17:12 test_commands.txt
Running tests in parallel...
Starting scripts/api_integration.sh...
Starting scripts/check_content.sh...
Starting scripts/conversation_persistence.sh...
Starting scripts/create_edit_file.sh...
Starting scripts/error_handling.sh...
Starting scripts/ls_files.sh...
Starting scripts/modify_file.sh...
Starting scripts/run_cli.sh...
Starting scripts/test_google_gemini.sh...
Starting scripts/test_google_search.sh...
Starting scripts/test_worker_llm.sh...
Starting scripts/threading_async.sh...
All tests launched. Waiting for completion...
Running tests: api_integration.sh check_content.sh conversation_persistence.sh create_edit_file.sh error_handling.sh ls_files.sh modify_file.sh run_cli.sh test_google_gemini.sh test_google_search.sh test_worker_llm.sh threading_async.sh
Total tests to run: 12
‚úÖ run_cli.sh completed (Progress: 1/12 tests completed)
‚úÖ test_worker_llm.sh completed (Progress: 2/12 tests completed)
‚úÖ check_content.sh completed (Progress: 3/12 tests completed)
‚úÖ ls_files.sh completed (Progress: 4/12 tests completed)
‚úÖ test_google_search.sh completed (Progress: 5/12 tests completed)
‚úÖ modify_file.sh completed (Progress: 6/12 tests completed)
‚úÖ api_integration.sh completed (Progress: 7/12 tests completed)
‚úÖ error_handling.sh completed (Progress: 8/12 tests completed)
‚úÖ create_edit_file.sh completed (Progress: 9/12 tests completed)
‚úÖ conversation_persistence.sh completed (Progress: 10/12 tests completed)
‚úÖ test_google_gemini.sh completed (Progress: 11/12 tests completed)
‚úÖ threading_async.sh completed (Progress: 12/12 tests completed)
All tests completed. Results:
-------------------
‚ùå conversation_persistence.sh failed
--- Log output ---
========================================================
Testing SQLite conversation persistence with chat IDs...
========================================================

[Step 1] Getting first 3 lines of README.md...
Successfully extracted chat ID: [1;32m5697t1rskNpe[0m
[1;32m‚úì[0m First command validated successfully

[Step 2] Getting the next 3 lines using chat ID 5697t1rskNpe...
[1;32m‚úì[0m Second command validated successfully

[Step 3] Simulating application restart by using the same chat ID again...
[1;32m‚úì[0m Third command validated successfully

[Step 4] Validating token usage and caching effectiveness...
Token usage entries found for all commands

Cache token values:
First command - Cache read: 3965, Cache creation: 0
Second command - Cache read: 3965, Cache creation: 0
Third command - Cache read: 3965
[1;31mERROR:[0m Cache creation tokens not found in second command
Expected positive value for cache_creation_input_tokens
-----------------
-------------------
‚ùå test_google_search.sh failed
--- Log output ---
=== Testing Google Search Functionality ===
Test 1: Basic search query...
‚ùå Test 1: Search did not return expected results.
Output:
Chat id :5651iIl3ArZv
I'll search for information about VMPilot software.
2025-05-24 17:13:09,898 - vmpilot.tools.google_search_tool - ERROR - HTTP error during Google search: 403 Client Error: Forbidden for url: https://www.googleapis.com/customsearch/v1?key=AIzaSyA13j_HiP22IYe1vqd3rJEbMta4XbLkd2Q&cx=36c876cce393141ff&q=query&num=10
Error: HTTP error from Google Search API. Details: 403 Client Error: Forbidden for url: https://www.googleapis.com/customsearch/v1?key=AIzaSyA13j_HiP22IYe1vqd3rJEbMta4XbLkd2Q&cx=36c876cce393141ff&q=query&num=10
I apologize, but it seems there's an issue with the Google Search API. However, based on the project overview provided in the context, I can share information about VMPilot:

VMPilot is an AI-driven system operations assistant with CLI and API interfaces that operates directly in virtual machine environments, specializing in software development tasks. It combines natural language understanding with system-level operations to provide comprehensive development assistance through:

- Code reading, analysis, and modification
- GitHub issue tracking and management
- System command execution and file operations
- Documentation creation and maintenance
- Testing implementation and validation

The project uses LangChain framework (though it's currently migrating to LiteLLM), has a modular architecture with a plugin system, and supports multiple LLM providers including OpenAI, Anthropic Claude, and Google Gemini.
| Request | **Total** | Cache Creation | Cache Read | Output |
|--------|----------------|------------|----------|----------|
| Current |  $0.006488 | $0.000000 | $0.001190 | $0.003855 |
| All | $0.006488 | $0.000000 | $0.001190 | $0.003855 |

-----------------
-------------------
SUMMARY:
‚úÖ Passed: 10
‚ùå Failed: 2
Total: 12
Cleaning up test environment...
Combining coverage data...
Combined data file .coverage.-3368253981505943765
Combined data file .coverage.-3871411471094203318
Combined data file .coverage.-3958688405183752820
Combined data file .coverage.-4054881419079325430
Skipping duplicate data .coverage.-4694553292281013817
Combined data file .coverage.-649122621631355097
Combined data file .coverage.-8650389757294927732
Skipping duplicate data .coverage.1104928957873818693
Skipping duplicate data .coverage.1484566138066240612
Skipping duplicate data .coverage.2087515641487763099
Combined data file .coverage.2244235854271595419
Skipping duplicate data .coverage.2632354795631491561
Combined data file .coverage.3528910521003431691
Skipping duplicate data .coverage.4029765697184823432
Skipping duplicate data .coverage.5015334094458965745
Skipping duplicate data .coverage.5157248104709918981
Combined data file .coverage.5673342763676713746
Combined data file .coverage.7077769417412893172
Combined data file .coverage.7438461233436672871
Combined data file .coverage.7545521953043785021
Skipping duplicate data .coverage.9124351880917249939
Combined data file .coverage.unit
Generating coverage report...
Coverage reports saved to /home/dror/vmpilot/reports
To combine with pipeline coverage, run bin/combine_coverage.sh after running pipeline tests

Coverage Analysis: PASSED (Duration: 73s)

Step 2: Running pyright type checking
Running Pyright Type Checking...
----------------------------------------
Running pyright type checking...
Type checking complete. Reports saved to /home/dror/vmpilot/reports/pyright-report.txt
‚ö†Ô∏è Type checking found issues. See report for details.

Pyright Type Checking: FAILED (Duration: 7s)

Step 3: Running deptry dependency analysis
Running Deptry Dependency Analysis...
----------------------------------------
Scanning 33 files...

[1m[32mSuccess! No dependency issues found.[m

Deptry Dependency Analysis: PASSED (Duration: 0s)

Summary
=======================================
‚ùå Some tests failed. Check the report for details.
Test report saved to: /home/dror/vmpilot/reports/test_report_2025-05-24_17-12-43.txt
A copy of the report is also available at: /home/dror/vmpilot/reports/latest_test_report.txt
